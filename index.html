<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vyapar AI - Business OS</title>
    <!-- Typography & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:FILL@0..1&display=swap"
        rel="stylesheet">
    <style>
        :root {
            color-scheme: light;
            --bg: #fbf7f2;
            --surface: #ffffff;
            --surface-2: #fff7ed;
            --text: #111827;
            --muted: #6b7280;
            --border: rgba(15, 23, 42, 0.10);
            --shadow: 0 18px 50px rgba(2, 6, 23, 0.10);
            --shadow-soft: 0 8px 24px rgba(2, 6, 23, 0.08);
            --accent: #7c3aed;
            /* violet */
            --accent-2: #f59e0b;
            /* amber */
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #d97706;
            --radius: 16px;
            --radius-sm: 12px;
        }

        * {
            box-sizing: border-box;
        }

        html {
            height: 100%;
            min-height: 100vh;
        }

        body {
            font-family: "Plus Jakarta Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background:
                radial-gradient(1200px 600px at 10% -10%, rgba(124, 58, 237, 0.14), transparent 60%),
                radial-gradient(900px 520px at 110% 0%, rgba(245, 158, 11, 0.18), transparent 55%),
                var(--bg);
            margin: 0;
            padding: 24px;
            color: var(--text);
            min-height: 100vh;
            height: 100vh;
        }

        .page-shell {
            max-width: 1380px;
            margin: 0 auto;
        }

        .page-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 16px;
            margin: 8px 0 22px;
        }

        .brand-wordmark {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .brand-title {
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-size: 0.86rem;
            color: rgba(17, 24, 39, 0.9);
        }

        .brand-title span {
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.4);
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.10);
        }

        .brand-sub {
            margin: 0;
            color: var(--muted);
            font-size: 0.9rem;
        }

        .top-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 11px;
            border-radius: 999px;
            font-size: 0.78rem;
            color: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.35);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.86), rgba(248, 250, 252, 0.9));
            box-shadow: 0 8px 22px rgba(15, 23, 42, 0.12);
        }

        .bento-grid {
            display: grid;
            grid-template-columns: 0.95fr 1.2fr 1.1fr;
            grid-template-rows: auto;
            grid-template-areas:
                "history control decision";
            gap: 18px;
        }

        /* General Card Styles with Glassmorphism */
        .card {
            position: relative;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.4);
            padding: 18px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
            height: fit-content;
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            transition: all 400ms cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
        }

        .card:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 24px 60px rgba(2, 6, 23, 0.15), 0 0 40px rgba(124, 58, 237, 0.1);
            border-color: rgba(124, 58, 237, 0.3);
            background: rgba(255, 255, 255, 0.85);
        }

        .card-history {
            grid-area: history;
        }

        .card-control {
            grid-area: control;
        }

        .card-decision {
            grid-area: decision;
        }

        .card-title {
            margin: 0 0 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            letter-spacing: 0.7px;
            text-transform: uppercase;
            color: rgba(17, 24, 39, 0.85);
        }

        .card-title .title-accent {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            box-shadow: 0 6px 16px rgba(124, 58, 237, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        h3 {
            font-size: 0.95rem;
            color: var(--muted);
            margin-bottom: 15px;
        }

        .icon {
            font-family: "Material Symbols Rounded";
            font-weight: 400;
            font-style: normal;
            font-size: 18px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            -webkit-font-smoothing: antialiased;
        }

        .icon-lg {
            font-size: 20px;
        }

        .icon-muted {
            color: rgba(17, 24, 39, 0.55);
        }

        /* Inputs with Modern Animation */
        input,
        select {
            width: 100%;
            padding: 11px 12px;
            border: 2px solid rgba(15, 23, 42, 0.14);
            border-radius: 12px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.92);
            color: var(--text);
            outline: none;
            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        input:hover,
        select:hover {
            border-color: rgba(124, 58, 237, 0.25);
            background: rgba(255, 255, 255, 1);
        }

        input:focus,
        select:focus {
            border-color: rgba(124, 58, 237, 0.6);
            box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.15), 0 8px 24px rgba(124, 58, 237, 0.1);
            transform: translateY(-1px);
            background: rgba(255, 255, 255, 1);
        }

        label {
            font-size: 0.85rem;
            font-weight: 650;
            color: rgba(17, 24, 39, 0.78);
            display: block;
            margin-bottom: 6px;
        }

        hr {
            border: none;
            border-top: 1px solid rgba(15, 23, 42, 0.08);
            margin: 15px 0;
        }

        /* Buttons with Glow Animation */
        .btn-run {
            position: relative;
            background: linear-gradient(135deg, var(--accent), #a855f7);
            color: white;
            border: 2px solid transparent;
            padding: 12px 14px;
            width: 100%;
            border-radius: 14px;
            font-weight: 750;
            cursor: pointer;
            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 14px 30px rgba(124, 58, 237, 0.22);
            overflow: hidden;
        }

        .btn-run::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 500ms ease;
        }

        .btn-run:hover::before {
            left: 100%;
        }

        .btn-run:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 20px 50px rgba(124, 58, 237, 0.4), 0 0 30px rgba(124, 58, 237, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .btn-run:active {
            transform: translateY(0px) scale(0.98);
        }

        .btn-run:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.3), 0 20px 50px rgba(124, 58, 237, 0.4);
        }

        .btn-action {
            position: relative;
            background: var(--success);
            color: white;
            border: 2px solid transparent;
            padding: 10px 14px;
            border-radius: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            margin-top: 14px;
            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 14px 30px rgba(22, 163, 74, 0.18);
            overflow: hidden;
        }

        .btn-action::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 14px;
            padding: 2px;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 300ms;
        }

        .btn-action:hover::after {
            opacity: 1;
        }

        .btn-action:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 20px 40px rgba(22, 163, 74, 0.3), 0 0 20px rgba(22, 163, 74, 0.2);
        }

        .btn-action:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-action:disabled:hover {
            box-shadow: 0 14px 30px rgba(22, 163, 74, 0.18);
        }

        .btn-link {
            background: none;
            border: none;
            color: rgba(17, 24, 39, 0.55);
            font-size: 0.85rem;
            margin-top: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 10px;
        }

        .btn-link:hover {
            background: rgba(17, 24, 39, 0.05);
            color: rgba(17, 24, 39, 0.75);
        }

        /* Output Section */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.82rem;
            font-weight: 800;
            margin-bottom: 10px;
            border: 1px solid transparent;
            transition: all 300ms ease;
            position: relative;
            overflow: hidden;
        }

        .status-badge::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 300ms, height 300ms;
        }

        .status-badge:hover::before {
            width: 200%;
            height: 200%;
        }

        .risk-High,
        .risk-Critical {
            background: rgba(220, 38, 38, 0.10);
            color: #991b1b;
            border-color: rgba(220, 38, 38, 0.20);
        }

        .risk-Safe {
            background: rgba(22, 163, 74, 0.10);
            color: #166534;
            border-color: rgba(22, 163, 74, 0.20);
        }

        .output-content {
            background: rgba(255, 247, 237, 0.9);
            padding: 14px;
            border-radius: 14px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            border: 1px solid rgba(15, 23, 42, 0.08);
            border-left: 4px solid transparent;
            border-image: linear-gradient(to bottom, var(--accent), var(--accent-2)) 1;
        }

        .analysis-text {
            font-weight: 550;
            color: rgba(17, 24, 39, 0.85);
        }

        .editable {
            width: 100%;
            height: 250px;
            padding: 12px;
            border: 1px solid rgba(15, 23, 42, 0.14);
            border-radius: 12px;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
            font-size: 0.95rem;
            line-height: 1.5;
            resize: vertical;
            background: rgba(255, 255, 255, 0.95);
            color: rgba(17, 24, 39, 0.92);
            outline: none;
            transition: box-shadow 160ms ease, border-color 160ms ease;
        }

        .editable:focus {
            border-color: rgba(124, 58, 237, 0.55);
            box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.12);
        }

        .edit-hint {
            font-size: 0.8rem;
            color: rgba(17, 24, 39, 0.50);
            margin-top: 8px;
            text-align: right;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        /* Sidebar (History) */
        .history-item {
            border-bottom: 1px solid #f1f5f9;
            padding: 10px 0;
            font-size: 0.85rem;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-time {
            color: #94a3b8;
            font-size: 0.75rem;
        }

        .history-title {
            font-weight: 600;
        }

        /* Modern Loader */
        .spinner {
            width: 34px;
            height: 34px;
            border-radius: 999px;
            border: 3px solid rgba(17, 24, 39, 0.08);
            border-top-color: var(--accent);
            border-right-color: var(--accent-2);
            animation: spin 800ms cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            margin: 0 auto 10px;
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.3);
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Pulse animation for loading state */
        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @media (max-width: 1050px) {
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .bento-grid {
                grid-template-columns: 1fr;
                grid-template-areas: "history" "control" "decision";
            }

            body {
                padding: 16px;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                transition: none !important;
                animation: none !important;
            }
        }
    </style>
</head>

<body>

    <div class="page-shell">
        <div class="page-header">
            <div class="brand-wordmark">
                <div class="brand-title">
                    <span>Vyapar AI</span>
                </div>
                <p class="brand-sub">Autonomous Business Operating System</p>
            </div>
            <div class="top-pill">
                <span class="icon icon-lg">bolt</span>
                <span>Workspace ready</span>
            </div>
        </div>

        <div class="bento-grid">

            <div class="card card-history">
                <div class="card-title">
                    <span class="title-accent" aria-hidden="true"></span>
                    <span class="icon icon-muted">history</span>
                    <span>Recent Activity</span>
                </div>
                <div id="historyList">
                    <p style="color:#94a3b8; font-style:italic;">No recent actions.</p>
                </div>
                <button onclick="clearHistory()" class="btn-link">
                    <span class="icon">delete</span>
                    <span>Clear History</span>
                </button>
            </div>

            <div class="card card-control">
                <div class="card-title">
                    <span class="title-accent" aria-hidden="true"></span>
                    <span class="icon icon-muted">tune</span>
                    <span>Control Panel</span>
                </div>
                <label>Select Agent Module</label>
                <select id="agentMode" onchange="updateForm()">
                    <option value="churn">1. Customer Retention</option>
                    <option value="inventory">2. Inventory Manager</option>
                    <option value="leads">3. Lead Sales Agent</option>
                    <option value="expense">4. Expense Auditor</option>
                </select>
                <hr>
                <div id="dynamicInputs"></div>
                <button onclick="askAgent()" class="btn-run" id="btn">
                    <span class="icon">play_arrow</span>
                    <span>Run Agent</span>
                </button>
            </div>

            <div class="card card-decision">
                <div class="card-title">
                    <span class="title-accent" aria-hidden="true"></span>
                    <span class="icon icon-muted">neurology</span>
                    <span>Agent Decision</span>
                </div>

                <div id="loading" style="display:none; text-align:center; padding: 40px;">
                    <div class="spinner" aria-hidden="true"></div>
                    <p style="color: var(--muted); margin: 0;">Analyzing data & formulating strategy…</p>
                </div>

                <div id="resultBox" style="display:none;">
                    <div id="badgeContainer"></div>
                    <p id="analysisText" class="analysis-text"></p>

                    <div class="output-content">
                        <strong id="contentSubject" style="display:block; margin-bottom:10px;"></strong>
                        <div id="contentBody"></div>
                    </div>

                    <button id="actionBtn" class="btn-action" onclick="performAction()">
                        <span id="actionBtnIcon" aria-hidden="true">
                            <span class="icon">send</span>
                        </span>
                        <span id="actionBtnText">Perform Action</span>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- 1. FORM LOGIC ---
        const forms = {
            churn: `
                <label>Customer Name</label><input type="text" id="p1" value="Amit Verma">
                <label>Days Inactive</label><input type="number" id="p2" value="60">
                <label>Support Tickets</label><input type="number" id="p3" value="5">
                <label>Monthly Bill (₹)</label><input type="number" id="p4" value="2000">
                <input type="hidden" id="query" value="Analyze risk and draft retention plan.">
            `,
            inventory: `
                <label>Item Name</label><input type="text" id="p1" value="Basmati Rice">
                <label>Current Stock</label><input type="number" id="p2" value="15">
                <label>Daily Sales Avg</label><input type="number" id="p3" value="5">
                <input type="hidden" id="query" value="Check stock and draft PO if needed.">
            `,
            leads: `
                <label>Client Name</label><input type="text" id="p1" value="Rahul Traders">
                <label>Budget (₹)</label><input type="number" id="p2" value="60000">
                <label>Urgency (1-10)</label><input type="number" id="p3" value="9">
                <input type="hidden" id="query" value="Score lead and draft pitch.">
            `,
            expense: `
                <label>Vendor</label><input type="text" id="p1" value="Unknown Vendor">
                <label>Category</label><input type="text" id="p2" value="Office Supplies">
                <label>Amount (₹)</label><input type="number" id="p3" value="8000">
                <input type="hidden" id="query" value="Audit for fraud.">
            `
        };

        function updateForm() {
            document.getElementById('dynamicInputs').innerHTML = forms[document.getElementById('agentMode').value];
            document.getElementById('resultBox').style.display = 'none';
        }

        // --- 2. AGENT INTERACTION ---
        let currentResponse = null; // Store response for "Action" button

        async function askAgent() {
            const mode = document.getElementById('agentMode').value;
            const loader = document.getElementById('loading');
            const resultBox = document.getElementById('resultBox');

            loader.style.display = 'block';
            resultBox.style.display = 'none';

            // Build Payload
            let payload = { query: document.getElementById('query').value, data: {} };
            if (mode === 'churn') {
                payload.data = { customerName: document.getElementById('p1').value, days_inactive: parseInt(document.getElementById('p2').value), monthly_bill: 2000 };
            } else if (mode === 'inventory') {
                payload.data = { itemName: document.getElementById('p1').value, current_stock: parseInt(document.getElementById('p2').value), daily_sales_avg: 5 };
            } else if (mode === 'leads') {
                payload.data = { leadName: document.getElementById('p1').value, budget: 60000, urgency: 9 };
            } else if (mode === 'expense') {
                payload.data = { vendor: document.getElementById('p1').value, amount: 8000 };
            }

            try {
                const res = await fetch('http://localhost:3000/api/agent/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const json = await res.json();

                if (json.success) {
                    currentResponse = json.response; // Save for action button
                    renderResult(json.response);
                    addToHistory(mode, json.response.risk_level);
                } else {
                    alert("Error: " + json.error);
                }
            } catch (err) {
                alert("Failed to connect to backend.");
                console.error(err);
            } finally {
                loader.style.display = 'none';
            }
        }

        function renderResult(data) {
            const resultBox = document.getElementById('resultBox');
            resultBox.style.display = 'block';

            // 1. Badge
            const badge = document.getElementById('badgeContainer');
            const riskIcon = (data.risk_level === 'Safe')
                ? `<span class="icon" aria-hidden="true">check_circle</span>`
                : `<span class="icon" aria-hidden="true">warning</span>`;
            badge.innerHTML = `<span class="status-badge risk-${data.risk_level}">${riskIcon}<span>Risk: ${data.risk_level}</span></span>`;

            // 2. Analysis
            document.getElementById('analysisText').innerText = data.analysis;

            // 3. Content Box
            document.getElementById('contentSubject').innerText = data.content.subject || "Report";

            // --- EDITABLE TEXT AREA LOGIC ---
            document.getElementById('contentBody').innerHTML = `
                <textarea id="editableBody" class="editable">${data.content.body}</textarea>
                <div class="edit-hint">
                    <span class="icon" aria-hidden="true">edit</span>
                    <span>You can edit this text before sending</span>
                </div>
            `;

            // 4. Dynamic Action Button
            const btn = document.getElementById('actionBtn');
            const btnText = document.getElementById('actionBtnText');
            const btnIcon = document.getElementById('actionBtnIcon');
            btnText.innerText = data.action_title || "Perform Action";

            // Color code button based on action type
            if (data.action_type === 'Audit') {
                btn.style.background = 'var(--danger)';
                btn.style.borderColor = 'rgba(220, 38, 38, 0.35)';
                btnIcon.innerHTML = `<span class="icon" aria-hidden="true" style="color:white;">warning</span>`;
            } else if (data.action_type === 'Purchase Order') {
                btn.style.background = 'var(--warning)';
                btn.style.borderColor = 'rgba(217, 119, 6, 0.35)';
                btnIcon.innerHTML = `<span class="icon" aria-hidden="true" style="color:white;">description</span>`;
            } else {
                btn.style.background = 'var(--success)';
                btn.style.borderColor = 'rgba(22, 163, 74, 0.35)';
                btnIcon.innerHTML = `<span class="icon" aria-hidden="true" style="color:white;">send</span>`;
            }
        }

        // --- 3. ACTION SIMULATION (The "Doing Work" Part) ---
        function performAction() {
            if (!currentResponse) return;

            // Grab the FINAL text (in case the user edited it)
            const finalBody = document.getElementById('editableBody') ? document.getElementById('editableBody').value : "";

            const type = currentResponse.action_type;
            let msg = "";

            if (type === 'Email') {
                msg = `Email sent to ${currentResponse.content.recipient || 'Customer'} successfully via SMTP.\n\n(Content: "${finalBody.substring(0, 30)}...")`;
            } else if (type === 'Purchase Order') {
                msg = `Purchase Order #${Math.floor(Math.random() * 1000)} generated and emailed to supplier.\n\n(Item: ${document.getElementById('p1').value})`;
            } else if (type === 'Audit') {
                msg = `Expense flagged in Accounting Software. Notification sent to Admin.`;
            } else {
                msg = `Action completed successfully.`;
            }

            // Simulate "Working" delay then show alert
            const btn = document.getElementById('actionBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span aria-hidden="true" class="spinner" style="width:18px;height:18px;border-width:2px;margin:0;"></span><span style="margin-left:8px;">Processing…</span>`;
            btn.disabled = true;

            setTimeout(() => {
                alert(msg);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 1000);
        }

        // --- 4. PERSISTENCE (History) ---
        function addToHistory(module, status) {
            const list = document.getElementById('historyList');
            const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const moduleName = module.charAt(0).toUpperCase() + module.slice(1);

            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `
                <div class="history-time">${now}</div>
                <div class="history-title">${moduleName} Agent</div>
                <div>Status: ${status}</div>
            `;

            // Remove "No recent actions" text if it exists
            if (list.innerText.includes("No recent")) list.innerHTML = "";

            list.prepend(item);

            // Save to LocalStorage
            let history = JSON.parse(localStorage.getItem('vyapar_history') || "[]");
            history.unshift({ time: now, module: moduleName, status: status });
            localStorage.setItem('vyapar_history', JSON.stringify(history.slice(0, 10)));
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('vyapar_history') || "[]");
            const list = document.getElementById('historyList');

            if (history.length > 0) {
                list.innerHTML = "";
                history.forEach(h => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <div class="history-time">${h.time}</div>
                        <div class="history-title">${h.module} Agent</div>
                        <div>Status: ${h.status}</div>
                    `;
                    list.appendChild(item);
                });
            }
        }

        function clearHistory() {
            localStorage.removeItem('vyapar_history');
            document.getElementById('historyList').innerHTML = '<p style="color:#94a3b8; font-style:italic;">No recent actions.</p>';
        }

        // Init
        updateForm();
        loadHistory();

    </script>
</body>

</html>